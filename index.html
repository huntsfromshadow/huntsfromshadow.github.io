<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
</head>

<body>
  <h1>ATE Build Calculator</h1>

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
    Notes / Changelog
  </button>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Notes / Changelog</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>This is a aid for doing build calculations in ATE.</p>
          <p>Please double check all math yourself using the Crafting Compendium. Reload the page to reset qualities.
          </p>
          <p>This app <b>will not</b> stop you from making an illegal crafted item.</p>

          <p>Changelog
            <ul>
              <li>v1 2/5/2020 - First Version.</li>
            </ul>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <div class="container">
    <div class="row">
      <div class="col-sm-6">What do you want to build?</div>
      <div class="col-sm-6">Results</div>
    </div>
    <div class="row">
      <div class="col-sm-6">
        <select class="form-control" id="object_to_build">
        </select>

        <select class="form-control" id="consumable_level">
          <option>Foolproof / Basic</option>
          <option>Intermediate</option>
          <option>Advanced</option>
        </select>

        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="alreadyExistCB">
          <label class="form-check-label" for="alreadyExistCB">Item Already Exists - Remove Create Cost</label>
        </div>


        <p></p>
        <p>Add Qualities</p>
        <select class="form-control" id="quality_to_add">
        </select>
        <button type="submit" class="btn btn-primary" id="add_qual_button">
          Add Quality
        </button>
      </div>
      <div class="col-sm-6">
        <p>Building:
          <div id="build_name"></div>
          <div id="notcalc_label">Not Calculated In</div>
        </p>

        <p>With Qualities:
          <ul id="qual-list"></ul>
        </p>
        <hr />
        <p>AP Cost: <div id="ap_total">0</div>
        </p>
        <p>MU Cost: <div id="mu_total">0</div>
        </p>
        <p>Notes:</p>
      </div>
    </div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

  <script>

    var dataset_objects = [
      { "name": "Gun", "bc": 2, "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "P" },
      { "name": "Close Weapon", "bc": 2, "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "P" },
      { "name": "Nanowoven Jewelry", "bc": 0, "bc_skill": "Nanoweavin", "mc": 2, "mc_type": "Nano", "type": "P" },
      { "name": "Superior Kit", "bc": 12, "bc_skill": "Junkin", "mc": 2, "mc_type": "Varies", "type": "P" },
      { "name": "Bow", "bc": 2, "bc_skill": "Junkin", "mc": 1, "mc_type": "Biomass or Scrap", "type": "P" },
      { "name": "Thrown Weapon Brace", "bc": 2, "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "P" },
      { "name": "Armor", "bc": 0, "bc_skill": "", "mc": 0, "mc_type": "", "type": "P" },

      { "name": "Absorber Pack", "bc": [1, 2, 3], "bc_skill": "Junkin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Indulgence", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Quick-Stitcher", "bc": [2, 3, 4], "bc_skill": "Nanoweavin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Blue Goo", "bc": [1, 2, 3], "bc_skill": "Nanoweavin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Hypersuture", "bc": [2, 3, 4], "bc_skill": "Nanoweavin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Biofoam", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Trauma Pack", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Antiemetic", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Recovery Promoter", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Septic Extract", "bc": [1, 2, 3], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Extreme Indulgence", "bc": [2, 4, 6], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Basic Lock", "bc": [1, 2, 3], "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "C" },
      { "name": "Trap", "bc": [1, 2, 3], "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "C" },
      { "name": "Fortitude Booster", "bc": [2, 4, 6], "bc_skill": "Medicine", "mc": 1, "mc_type": "Biomass", "type": "C" },
      { "name": "Napalm Grenade", "bc": 1, "bc_skill": "Junkin", "mc": 1, "mc_type": "Scrap", "type": "C" },
      { "name": "Web Grenade", "bc": 1, "bc_skill": "Junkin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "EMP Grenade", "bc": 1, "bc_skill": "Junkin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Snapshot Blank", "bc": [1, 2, 3], "bc_skill": "Junkin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Refraction Field", "bc": [1, 2, 3], "bc_skill": "Junkin", "mc": 1, "mc_type": "Nano", "type": "C" },
      { "name": "Gas Mask Filter", "bc": 1, "bc_skill": "Junkin", "mc": 1, "mc_type": "Bio", "type": "C" },
    ]

    var dataset_qualities = [
      { "name": "Rifle", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Expanded Heat Sink", "bc": 1, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Hyperdense", "bc": 2, "bc_skill": "Nanoweavin", "attach": "Armor" },
      { "name": "User-Friendly", "bc": 4, "bc_skill": "Nanoweavin", "attach": "Nanowoven Jewelry" },
      { "name": "Soothing", "bc": 2, "bc_skill": "Nanoweavin", "attach": "Nanowoven Jewelry" },
      { "name": "Regalia", "bc": 2, "bc_skill": "Nanoweavin", "attach": "Armor" },
      { "name": "Fine", "bc": 1, "bc_skill": "Medicine", "attach": "Indulgence" },
      { "name": "Suppressed", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Shotgun", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Suppressed", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Sharp", "bc": 2, "bc_skill": "Junkin", "attach": "Close Weapon" },
      { "name": "Revolver", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Automatic", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Holdout", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Extra Heavy", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Magnum Barrel", "bc": 3, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Sighted In", "bc": 3, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Badass Custom Plating", "bc": 1, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Powered - Weapon", "bc": 2, "bc_skill": "Junkin", "attach": "Close Weapon" },
      { "name": "Powered - Armor", "bc": 4, "bc_skill": "Nanoweavin", "attach": "Armor" },
      { "name": "Weighted Head", "bc": 3, "bc_skill": "Junkin", "attach": "Close Weapon" },
      { "name": "Magnetic Returner", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Tangled Wire", "bc": 2, "bc_skill": "Junkin", "attach": "Thrown Weapon Brace" },
      { "name": "Paired", "bc": 2, "bc_skill": "Junkin", "attach": "Gun" },
      { "name": "Lethal", "bc": 2, "bc_skill": "Junkin", "attach": "Thrown Weapon Brace" },
      { "name": "Toxic", "bc": 0, "bc_skill": "NA", "attach": "Indulgence or Bracer" },
      { "name": "Nutritious", "bc": 0, "bc_skill": "NA", "attach": "Bracer" },


    ]

    $(function () {
      $("#consumable_level").hide()
      $("#consumable_level").change(function (e) {
        processResults();
      });

      //SETUP ADD QUAL BUTTON
      $("#add_qual_button").click(function () {
        //Have to move quality over
        var $ql = $("#qual-list");
        var qual = $("#quality_to_add").find(":selected")[0];

        var $e = $("<li />")
        $e.text(qual.text);

        for (var d in qual.dataset) {
          $e.attr("data-" + d, qual.dataset[d])
        }

        $ql.append($e)
        processResults()

      });

      //SETUP OBJECT TO BUILD
      var $dropdown = $('#object_to_build');
      var firsttime = true;

      $.each(dataset_objects, function () {
        var $e = createOption(this)
        $dropdown.append($e)
      });

      $("#object_to_build").change(function () {
        //We need to fill the quality field
        var obj_name = $("#object_to_build").val();
        var $qual = $("#quality_to_add");

        //Clear quality textbox
        $qual.empty();

        dataset_qualities.forEach(elem => {
          if (elem.attach == obj_name) {
            var $e = createOption(elem)
            $qual.append($e)
          }
        });

        $("#build_name").empty();
        var $e = $("<div id='the_object' />")
        var $ob = $("#object_to_build").find(":checked");
        $e.text($ob.text());
        for (var d in $ob[0].dataset) {
          $e.attr("data-" + d, $ob[0].dataset[d])
        }


        $("#build_name").append($e);

        //See if consumable
        var $a = $("#object_to_build").find(":selected")
        if ($a[0].dataset.type == "C") {
          $("#consumable_level").show();
        }
        else {
          $("#consumable_level").hide();
        }

        //And Tell results to reprocess
        processResults();
      })
      $("#object_to_build").change();


      //SETUP ALREADY EXISTS CB
      $('#alreadyExistCB').change(function () {
        if ($('#alreadyExistCB').is(":checked")) {
          $("#notcalc_label").show()
        }
        else {
          $("#notcalc_label").hide()
        }
        processResults();
      })
      $('#alreadyExistCB').change();
    });


    function createOption(objdat) {
      var $e = $("<option />")
      $e.text(objdat.name);
      for (let key in objdat) {
        $e.attr("data-" + key, objdat[key])
      }
      return $e;
    }

    function processResults() {

      //Elements we need
      var $to = $("#the_object");
      var $ql = $('#qual-list li');
      var $apt = $("#ap_total");
      var $mut = $("#mu_total");
      var $cb = $("#alreadyExistCB");
      var $cl = $("#consumable_level");

      var final_mu = 0;
      var final_ap = 0;

      //First look at the object itself      
      if ($cb.is(":checked") == false) {
        //Calculate the object        
        //Okay consumables can have a range
        console.log($to[0])
        if ($to[0].dataset.type == "P") {
          final_ap = final_ap + parseInt($to[0].dataset.bc);
          final_mu = final_mu + parseInt($to[0].dataset.mc);
        }
        else {
          //Consumable
          var costs = $to[0].dataset.bc.split(",")
          if (costs.length == 1) {
            //It's a straight cost dosen't matter on tier
            final_ap = final_ap + parseInt($to[0].dataset.bc);
          }
          else {
            if ($cl.val() == "Foolproof / Basic") {
              final_ap = final_ap + parseInt(costs[0]);
            }
            else if ($cl.val() == "Intermediate") {
              final_ap = final_ap + parseInt(costs[1]);
            }
            else {
              final_ap = final_ap + parseInt(costs[2]);
            }
          }
          final_mu = final_mu + parseInt($to[0].dataset.mc);

        }
      }

      //Walk through the qualities
      var nq = 0;
      if ($ql.length != 0) {

        $ql.each(function (e) {
          if ($to[0].dataset.type == "C") {
            final_ap = final_ap + (nq * 2); //Qual increase            
            nq++;
          }
          else {
            final_ap = final_ap + (nq * 4);
            nq++;
          }
          final_ap = final_ap + parseInt(this.dataset.bc);
          final_mu = final_mu + 2;




        });
      }



      //Set the results      
      $mut.text(final_mu);
      $apt.text(final_ap);
    }





  </script>
</body>

</html>